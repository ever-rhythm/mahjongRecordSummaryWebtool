<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>战绩</title>
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>-->
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.staticfile.net/jquery/3.7.1/jquery.min.js"></script>
</head>
<body style="background-color: #100C2A;">
<!-- 为 ECharts 准备一个定义了宽高的 DOM -->
<div id="main2" style="top:100px;width: 960px;height:300px;position: relative;margin: auto;display: flex">
    <div id="maininfo" style="width: 400px;height:100%;position:relative;margin: auto;">
        <span style="padding-left:100px;font-weight:bold;font-size:18px;color: #EEF1FA">对局信息</span><br/><br/><br/>
        <span id='s0' style="padding-left:100px;font-weight:bold;font-size:18px;color: #4992ff"></span><br/>
        <span id='s1' style="padding-left:100px;font-weight:bold;font-size:18px;color: #4992ff"></span><br/>
        <span id='s2' style="padding-left:100px;font-weight:bold;font-size:18px;color: #4992ff"></span><br/>
        <span id='s3' style="padding-left:100px;font-weight:bold;font-size:18px;color: #4992ff"></span><br/>
        <span id='s4' style="padding-left:100px;font-weight:bold;font-size:18px;color: #4992ff"></span><br/>
        <span id='s5' style="padding-left:100px;font-weight:bold;font-size:18px;color: #4992ff"></span>
    </div>
    <div id="main1" style="height:100%;margin: auto;flex: 1"></div>
</div>
<div id="main" style="top:100px;width: 960px;height:800px;position: relative;margin: auto;"></div>
<script type="text/javascript">
    const getLength = (str) => {
        let charCount = 0;
        for (const char of str) {
            if (char.codePointAt(0) > 127) {
                charCount += 2;
            } else {
                charCount += 1;
            }
        }

        return charCount;
    }

    let myChart = echarts.init(document.getElementById('main'), 'dark');
    let chartBar = echarts.init(document.getElementById('main1'), 'dark');
    let params = new URLSearchParams(window.location.search)
    let intervalY = 5000
    let code = params.get('code')
    let date = params.get('date')
    let player = params.get('pl')

    myChart.showLoading('default', {
        fontSize: 30,
        maskColor: '#100C2A',
        color: '#4992ff',
        textColor: '#4992ff',
    });

    if (code == null || date == null || player == null) {
        alert('参数缺失')
    } else {
        $.ajax({
            type:'POST',
            url: '/api/group_player_trend',
            contentType: "application/json",
            data: JSON.stringify({
                code:code,
                date:date,
                player:player,
            }),
            success: function(result) {
                myChart.hideLoading();

                document.getElementById('s0').innerHTML = '昵称：' + player
                document.getElementById('s1').innerHTML = '总数：' + result.data.cntTotal
                document.getElementById('s2').innerHTML = '积分：' + result.data.lineTotal[result.data.cntTotal - 1]
                document.getElementById('s3').innerHTML = '点数：' + result.data.linePt[result.data.cntTotal - 1]
                document.getElementById('s4').innerHTML = '祝仪：' + result.data.lineZy[result.data.cntTotal - 1]
                document.getElementById('s5').innerHTML = '平顺：' + (( result.data.cnt1 + result.data.cnt2 * 2 + result.data.cnt3 * 3 + result.data.cnt4 * 4 ) / result.data.cntTotal ).toFixed(2)

                myChart.on('click', function (params) {
                    window.open('https://game.maj-soul.com/1/?paipu=' + encodeURIComponent(result.data.lineDetail[params.dataIndex].Paipu_Url));
                })

                myChart.setOption({
                    title: {
                        text:  '积分趋势（点击跳转牌谱）',
                        padding: [5, 100],
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                        },
                        position:['40%', '5%'],
                        formatter: function (params) {
                            let strTips = ''
                            let oneDetail = result.data.lineDetail[params[0].dataIndex]
                            let sizeSp = 15

                            strTips += '积分：' + result.data.lineTotal[params[0].dataIndex] + '</br>'
                            strTips += '点数：' + result.data.linePt[params[0].dataIndex] + '</br>'
                            strTips += '祝仪：' + result.data.lineZy[params[0].dataIndex] + '</br>'
                            strTips += '</br>'
                            strTips += oneDetail.Pl_1 + '&nbsp'.repeat(getLength(oneDetail.Pl_1) > sizeSp ? 0 : sizeSp - getLength(oneDetail.Pl_1)) + '点数 ' + oneDetail.Pt_1 + ' 祝仪 ' + oneDetail.Zy_1 + '</br>'
                            strTips += oneDetail.Pl_2 + '&nbsp'.repeat(getLength(oneDetail.Pl_2) > sizeSp ? 0 : sizeSp - getLength(oneDetail.Pl_2)) + '点数 ' + oneDetail.Pt_2 + ' 祝仪 ' + oneDetail.Zy_2 + '</br>'
                            strTips += oneDetail.Pl_3 + '&nbsp'.repeat(getLength(oneDetail.Pl_3) > sizeSp ? 0 : sizeSp - getLength(oneDetail.Pl_3)) + '点数 ' + oneDetail.Pt_3 + ' 祝仪 ' + oneDetail.Zy_3 + '</br>'
                            strTips += oneDetail.Pl_4 + '&nbsp'.repeat(getLength(oneDetail.Pl_4) > sizeSp ? 0 : sizeSp - getLength(oneDetail.Pl_4)) + '点数 ' + oneDetail.Pt_4 + ' 祝仪 ' + oneDetail.Zy_4 + '</br>'

                            return strTips
                        }
                    },
                    legend: {
                    },
                    grid:{
                        top:'middle',
                    },
                    xAxis: {
                        type: 'category',
                        data: result.data.date
                    },
                    yAxis: {
                        type: 'value',
                        interval: intervalY,
                    },
                    series: [
                        {
                            name: '点数',
                            type: 'line',
                            smooth: false,
                            data: result.data.linePt,
                            itemStyle: {
                                color:'#4992ff',
                            },
                        },
                        {
                            name: '祝仪',
                            type: 'line',
                            smooth: false,
                            data: result.data.lineZy,
                            itemStyle: {
                                color:'#fddd60',
                            },
                        },
                        {
                            name: '合计',
                            type: 'line',
                            smooth: false,
                            data: result.data.lineTotal,
                            itemStyle: {
                                color:'#7cffb2',
                            },
                        },
                    ]
                });

                chartBar.setOption({
                    title: {
                        text: '顺位分布',
                        left: 'center',
                        top: 'center',
                    },
                    series: [
                        {
                            type: 'pie',
                            radius: ['50%', '70%'],
                            // bottom: 20,
                            label: {
                                // alignTo: 'edge',
                                formatter: '{name|{b} {c}战}\n{per|{d}%}',
                                minMargin: 5,
                                edgeDistance: 10,
                                lineHeight: 15,
                                rich: {
                                    time: {
                                        color: '#999'
                                    }
                                }
                            },
                            data: [
                                {
                                    name: '2位',
                                    value: result.data.cnt2,
                                    itemStyle: {
                                        color:'#7cffb2',
                                    }
                                },
                                {
                                    name: '3位',
                                    value: result.data.cnt3,
                                    itemStyle: {
                                        color:'#fddd60',
                                    }
                                },
                                {
                                    name: '4位',
                                    value: result.data.cnt4,
                                    itemStyle: {
                                        color:'#ff6e76',
                                    }
                                },
                                {
                                    name: '1位',
                                    value: result.data.cnt1,
                                    itemStyle: {
                                        color:'#4992ff',
                                    }
                                },
                            ],
                        }
                    ],
                });
            },
            error: function(xhr, status, error) {
                alert(error)
            }
        })
    }
</script>
</body>
</html>