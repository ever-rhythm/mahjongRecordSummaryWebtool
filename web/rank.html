<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>排行榜</title>
<!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>-->
<!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>-->
  <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>
  <script src="https://cdn.staticfile.net/jquery/3.7.1/jquery.min.js"></script>
</head>
<body style="background-color: #100C2A;">
<div id="main" style="top:100px;width:960px;height:1200px;position: relative;margin: auto;"></div>
<script type="text/javascript">
  let chartBar = echarts.init(document.getElementById('main'), 'dark');
  let herfPrefix = 'http://127.0.0.1'
  // let herfPrefix = 'http://120.24.252.53'
  // let herfPrefix = 'http://www.mjget.top'
  let intervalX = 10000
  let barHeight = 80
  let barGap = '30%'
  let imgHeight = 30
  let imgWidth = 30
  let queryString = new URLSearchParams(window.location.search)
  let code = queryString.get('code')
  let date = queryString.get('date')

  if (date == null || date.length === 0) {
    let d = new Date()
    let month = (d.getMonth()+1 < 10 ? '0'+(d.getMonth()+1):d.getMonth()+1) ;
    date = d.getFullYear().toString() + '-' + month + '-01'
    alert(date)
  }

  chartBar.on('click', function(params) {
    window.open(herfPrefix + '/trend.html' + '?code=' + code + '&date=' + date + '&pl=' + encodeURIComponent(params.name));
  });
  chartBar.showLoading('default', {
    fontSize: 30,
    maskColor: '#100C2A',
    color: '#4992ff',
    textColor: '#4992ff',
  });

  if (code == null) {
    alert('参数缺失')
  } else {
    $.ajax({
      type:'POST',
      url: '/api/group_rank',
      contentType: "application/json",
      data: JSON.stringify({
        code:code,
        date:date,
      }),
      success: function(result) {
        chartBar.hideLoading();

        let barOption = {
          title: {
            text:  '排行榜',
            padding: [5, 50],
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'shadow'
            },
            formatter: function (params) {
              let strTips = params[0].name + '</br></br>'

              if (params[0] != null && params[0].value != null ){
                strTips += '合计：' + (params[0].value + result.data.lineNegaTotal[params[0].dataIndex]).toString() + '</br>'
              }

              return strTips
            }
          },
          legend: {},
          grid: {
            containLabel: true,
            left: '5%',
            right: '4%',
            bottom: '3%',
          },
          xAxis: {
            show: false,
            type: 'value',
            boundaryGap: [0, 0.05],
            interval:intervalX,
          },
          yAxis: {
            type: 'category',
            data: result.data.player,

            axisLabel: {
              formatter: (value) => {
                let plSize = result.data.player.length


                if ( plSize - 1 >= 0 && value === result.data.player[plSize- 1]) {
                  return '{x|}' + ' ' + value
                } else if ( plSize - 2 >= 0 && value === result.data.player[plSize- 2]) {
                  return '{b|}' + ' ' + value
                } else if ( plSize - 3 >= 0 && value === result.data.player[plSize- 3]) {
                  return '{c|}' + ' ' + value
                } else {
                  return value
                }
              },
              rich: {
                x: {
                  height:imgHeight,
                  width:imgWidth,
                  backgroundColor: {
                    image: herfPrefix + '/static/1st.png',
                  }
                },
                b: {
                  height: imgHeight,
                  width:imgWidth,
                  backgroundColor: {
                    image: herfPrefix + '/static/2nd.png',
                  }
                },
                c: {
                  height: imgHeight,
                  width:imgWidth,
                  backgroundColor: {
                    image: herfPrefix + '/static/3rd.png',
                  }
                },
              },
            }


          },
          series: [
            {
              name: '合计',
              type: 'bar',
              label: {
                show: true,
                position:'insideLeft',
                formatter: function (params) {
                  return (params.value + result.data.lineNegaTotal[params.dataIndex]).toString()
                },
              },
              data: result.data.lineTotal,
              barMinHeight: barHeight,
              barCategoryGap: barGap,
            },
          ]
        }

        // 前三颜色，正负颜色
        let lengthSeries = barOption.series[0].data.length
        for (let i = 0;i < lengthSeries ;i++){
          let oneColor = "#5470c6"

          if ( i === lengthSeries - 1 ){
            oneColor = "#fddd60"
          } else if ( i === lengthSeries - 2) {
            oneColor = "#F0F8FF"
          } else if ( i === lengthSeries - 3) {
            oneColor = "#fc8452"
          } else if (barOption.series[0].data[i] > 0) {
            oneColor = "#91cc75"
          } else {
            oneColor = "#5470c6"
          }

          barOption.series[0].data[i] = {
            value: barOption.series[0].data[i],
            itemStyle: {
              color: oneColor,
            }
          }

        }

        // resize
        chartBar.resize({
          width: 960,
          height: barHeight * result.data.lineTotal.length > 1800 ? 1800 : barHeight * result.data.lineTotal.length
        });

        chartBar.setOption(barOption);
      },
      error: function(xhr, status, error) {
        alert(error)
      }
    })
  }
</script>
</body>
</html>
